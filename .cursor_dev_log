## [2026-01-07 14:40] Fix Invite Route & Infinite Loading
- **Goal**: Fix "Already Joined" infinite loading bug and I18n SyntaxError in RoomStore.
- **Changes**:
  - `frontend/vue-ezchat/src/assets/main.css`: Added z-index override (100000) for `.el-overlay`.
  - `frontend/vue-ezchat/src/stores/roomStore.ts`: Reverted to blocking `showAlertDialog`, fixed `useI18n` usage.
  - `frontend/vue-ezchat/src/utils/request.ts`: Removed redundant error handling.
  - `frontend/vue-ezchat/src/router/index.ts`: Updated invite route guard.
  - `frontend/vue-ezchat/src/hooks/chat/join/useJoinInput.ts`: Fixed `useI18n` usage outside setup.
  
## [2026-01-07 14:45] Internationalize Join Chat Success Message
- **Goal**: Internationalize success message in router invite validation
- **Changes**:
  - [MODIFY] `router/index.ts` (line 204):
    - Internationalized success message: `ElMessage.success('Join chat successfully')` → `ElMessage.success(t('api.join_chat_success'))`
  - [MODIFY] `i18n/locales/en.json`:
    - Added `join_chat_success` translation key: "Join chat successfully"
  - [MODIFY] `i18n/locales/zh.json`:
    - Added `join_chat_success` translation key: "成功加入聊天室"
  - [MODIFY] `i18n/locales/ja.json`:
    - Added `join_chat_success` translation key: "チャットに参加しました"
  - [MODIFY] `i18n/locales/ko.json`:
    - Added `join_chat_success` translation key: "채팅에 참여했습니다"
  - [MODIFY] `i18n/locales/zh-tw.json`:
    - Added `join_chat_success` translation key: "成功加入聊天室"
  
## [2026-01-07 14:50] Complete Globalization of Invite Verification Text
- **Goal**: Fully internationalize invite verification loading text
- **Changes**:
  - [MODIFY] `router/index.ts` (line 147):
    - Removed fallback text: `t('common.verifying_invitation') || 'Verifying invitation...'` → `t('common.verifying_invitation')`
  - [MODIFY] `i18n/locales/en.json`:
    - Added `verifying_invitation` translation key: "Verifying invitation..."
  - [MODIFY] `i18n/locales/zh.json`:
    - Added `verifying_invitation` translation key: "验证邀请中..."
  - [MODIFY] `i18n/locales/ja.json`:
    - Added `verifying_invitation` translation key: "招待を確認中..."
  - [MODIFY] `i18n/locales/ko.json`:
    - Added `verifying_invitation` translation key: "초대 확인 중..."
  - [MODIFY] `i18n/locales/zh-tw.json`:
    - Added `verifying_invitation` translation key: "驗證邀請中..."
## [2026-01-07 15:52] Refactor Invite Route Logic
- **Goal**: Extract complex invite verification logic from router guard to a dedicated service service.
- **Changes**:
  - NEW `frontend/vue-ezchat/src/services/inviteService.ts`: Contains `processInviteRoute` logic.
  - MOD `frontend/vue-ezchat/src/router/index.ts`: Replaced inline logic with `processInviteRoute` call.
  
## [2026-01-07 15:55] Internationalize Image Upload Error Message
- **Goal**: Internationalize Japanese error message in useUpload hook
- **Changes**:
  - [MODIFY] `hooks/useUpload.ts`:
    - Added i18n import: `import i18n from '@/i18n'`
    - Added t function inside customUpload method: `const { t } = i18n.global`
    - Internationalized error message: `ElMessage.error('画像のアップロードに失敗しました')` → `ElMessage.error(t('api.image_upload_failed'))`
  - [MODIFY] `i18n/locales/en.json`:
    - Added `image_upload_failed` translation key: "Image upload failed."
  - [MODIFY] `i18n/locales/zh.json`:
    - Added `image_upload_failed` translation key: "图片上传失败。"
  - [MODIFY] `i18n/locales/ja.json`:
    - Added `image_upload_failed` translation key: "画像のアップロードに失敗しました。"
  - [MODIFY] `i18n/locales/ko.json`:
    - Added `image_upload_failed` translation key: "이미지 업로드에 실패했습니다。"
  - [MODIFY] `i18n/locales/zh-tw.json`:
    - Added `image_upload_failed` translation key: "圖片上傳失敗。"
  
## [2026-01-07 16:00] Fix Missing Translation Key in GuestAside
- **Goal**: Fix missing 'aside.current_chat' and 'aside.no_chat' translation key warnings
- **Changes**:
  - [MODIFY] `views/layout/components/GuestAside.vue` (line 165):
    - Removed fallback text: `t('aside.current_chat', '当前会话')` → `t('aside.current_chat')`
  - [MODIFY] `views/layout/components/GuestAside.vue` (line 172):
    - Removed fallback text: `t('aside.no_chat', '暂无会话')` → `t('aside.no_chat')`
  - [MODIFY] `i18n/locales/en.json`:
    - Added `current_chat` translation key in aside section: "Current Chat"
    - Added `no_chat` translation key in aside section: "No chat"
  - [MODIFY] `i18n/locales/zh.json`:
    - Added `current_chat` translation key in aside section: "当前会话"
    - Added `no_chat` translation key in aside section: "暂无会话"
  - [MODIFY] `i18n/locales/ja.json`:
    - Added `current_chat` translation key in aside section: "現在のチャット"
    - Added `no_chat` translation key in aside section: "チャットがありません"
  - [MODIFY] `i18n/locales/ko.json`:
    - Added `current_chat` translation key in aside section: "현재 채팅"
    - Added `no_chat` translation key in aside section: "채팅이 없습니다"
  - [MODIFY] `i18n/locales/zh-tw.json`:
    - Added `current_chat` translation key in aside section: "當前會話"
    - Added `no_chat` translation key in aside section: "暫無會話"
  
## [2026-01-07 16:10] Complete Globalization of useGuestJoin Hook
- **Goal**: Internationalize all hardcoded English messages in useGuestJoin hook
- **Changes**:
  - [MODIFY] `hooks/chat/join/useGuestJoin.ts`:
    - Line 182: `ElMessage.warning('Room ID is missing in URL')` → `ElMessage.warning(t('chat.room_id_missing'))`
    - Line 188: `ElMessage.warning('Invalid Room ID format in URL')` → `ElMessage.warning(t('chat.invalid_room_id_format'))`
    - Line 195: `ElMessage.warning('Room code mismatch')` → `ElMessage.warning(t('chat.room_code_mismatch'))`
    - Line 202: `ElMessage.warning(t('validation.nickname_invalid') || 'Invalid Nickname')` → `ElMessage.warning(t('validation.nickname_invalid'))`
    - Line 210: `ElMessage.error('Validation info expired, please restart')` → `ElMessage.error(t('chat.validation_info_expired'))`
    - Line 223: `ElMessage.warning('Avatar upload failed, using default')` → `ElMessage.warning(t('chat.avatar_upload_failed'))`
    - Line 233: `ElMessage.error('Target chat code is missing')` → `ElMessage.error(t('chat.target_chat_code_missing'))`
    - Line 255: `ElMessage.error('Invalid validation info')` → `ElMessage.error(t('chat.invalid_validation_info'))`
    - Line 265: `ElMessage.success(t('chat.join_success') || 'Joined successfully')` → `ElMessage.success(t('chat.join_success'))`
  - [MODIFY] `i18n/locales/en.json`:
    - Added `room_id_missing`: "Room ID is missing in URL"
    - Added `invalid_room_id_format`: "Invalid Room ID format in URL"
    - Added `room_code_mismatch`: "Room code mismatch"
    - Added `validation_info_expired`: "Validation info expired, please restart"
    - Added `avatar_upload_failed`: "Avatar upload failed, using default"
    - Added `target_chat_code_missing`: "Target chat code is missing"
    - Added `invalid_validation_info`: "Invalid validation info"
  - [MODIFY] `i18n/locales/zh.json`:
    - Added `room_id_missing`: "URL中缺少房间ID"
    - Added `invalid_room_id_format`: "URL中的房间ID格式无效"
    - Added `room_code_mismatch`: "房间代码不匹配"
    - Added `validation_info_expired`: "验证信息已过期，请重新开始"
    - Added `avatar_upload_failed`: "头像上传失败，使用默认头像"
    - Added `target_chat_code_missing`: "目标聊天代码缺失"
    - Added `invalid_validation_info`: "验证信息无效"
  - [MODIFY] `i18n/locales/ja.json`:
    - Added `room_id_missing`: "URLにルームIDがありません"
    - Added `invalid_room_id_format`: "URLのルームID形式が無効です"
    - Added `room_code_mismatch`: "ルームコードが一致しません"
    - Added `validation_info_expired`: "検証情報の有効期限が切れました。再開してください"
    - Added `avatar_upload_failed`: "アバターのアップロードに失敗しました。デフォルトを使用します"
    - Added `target_chat_code_missing`: "ターゲットチャットコードがありません"
    - Added `invalid_validation_info`: "検証情報が無効です"
  - [MODIFY] `i18n/locales/ko.json`:
    - Added `room_id_missing`: "URL에 룸 ID가 없습니다"
    - Added `invalid_room_id_format`: "URL의 룸 ID 형식이 잘못되었습니다"
    - Added `room_code_mismatch`: "룸 코드가 일치하지 않습니다"
    - Added `validation_info_expired`: "검증 정보가 만료되었습니다. 다시 시작해 주세요"
    - Added `avatar_upload_failed`: "아바타 업로드에 실패했습니다. 기본값을 사용합니다"
    - Added `target_chat_code_missing`: "대상 채팅 코드가 없습니다"
    - Added `invalid_validation_info`: "검증 정보가 유효하지 않습니다"
  - [MODIFY] `i18n/locales/zh-tw.json`:
    - Added `room_id_missing`: "URL中缺少房間ID"
    - Added `invalid_room_id_format`: "URL中的房間ID格式無效"
    - Added `room_code_mismatch`: "房間代碼不匹配"
    - Added `validation_info_expired`: "驗證資訊已過期，請重新開始"
    - Added `avatar_upload_failed`: "頭像上傳失敗，使用預設頭像"
    - Added `target_chat_code_missing`: "目標聊天代碼缺失"
    - Added `invalid_validation_info`: "驗證資訊無效"
## [2026-01-07 17:31] Fix Typescript Error in messageStore.ts
- **Goal**: Resolve 'Pick<Message, images>' error by decoupling image processing from strict Message union types.
- **Changes**: Modified 'sendMessage' in messageStore.ts to iterate image array directly.
## [2026-01-07 17:36] Refactor WebSocket Protocol
- **Goal**: Decouple Message types and use Status Codes (1001, 3001) for clearer protocol distinction.
- **Changes**: Updated WebSocketResult.java, ChatServiceImpl.java, WebSocketServer.java, type/index.ts, useWebsocket.ts.
  
## [2026-01-07 17:45] Fix TypeScript Error: Missing 'images' Property in Message Union Type
- **Goal**: Fix TypeScript error where accessing `images` property on `Message` union type fails because some message types (RoomCreatedMessage, MemberJoinMessage) don't have this property.
- **Changes**:
  - [MODIFY] `type/index.ts`:
    - Added new type `InputMessage = TextMessage | ImageMessage | MixedMessage` for input content
    - This type only includes message types that have `images` property (even if it's `never[]`)
  - [MODIFY] `hooks/useChatInput.ts`:
    - Changed `inputContent` type from `Message` to `InputMessage`
    - Updated import statement to use `InputMessage` instead of `Message`
  - **Explanation**: The `Message` union type includes system messages (RoomCreatedMessage, MemberJoinMessage) that don't have `images` property. By creating a dedicated `InputMessage` type that only includes user-inputtable message types, we ensure type safety when accessing `inputContent.images` in the template.
  
## [2026-01-07 17:50] Fix TypeScript Error: Missing 'images' Property in MessageItem Component
- **Goal**: Fix TypeScript error where accessing `images` property on `Message` union type in MessageItem component fails because some message types don't have this property.
- **Changes**:
  - [MODIFY] `views/chat/components/MessageItem.vue`:
    - Added type guard function `hasImages` to check if a message has `images` property
    - Added computed property `messageImages` that safely returns `Image[]` using the type guard
    - Updated all usages of `props.msg.images` to use `messageImages.value` (in script) or `messageImages` (in template)
    - Updated `openViewer` function to use `messageImages.value`
    - Updated `watchEffect` to use `messageImages.value`
    - Updated template to use `messageImages` instead of `msg.images`
  - **Explanation**: The `Message` union type includes system messages (RoomCreatedMessage, MemberJoinMessage) that don't have `images` property. By using a type guard function and computed property, we safely access `images` only when it exists, ensuring type safety throughout the component.
  
## [2026-01-07 17:55] Move Type Guard Function to validators.ts
- **Goal**: Move `hasImages` type guard function from MessageItem.vue to validators.ts for better code organization and reusability.
- **Changes**:
  - [MODIFY] `utils/validators.ts`:
    - Added type imports: `Message`, `TextMessage`, `ImageMessage`, `MixedMessage`
    - Added `hasImages` type guard function to check if a message has `images` property
  - [MODIFY] `views/chat/components/MessageItem.vue`:
    - Removed local `hasImages` function definition
    - Added import: `import {hasImages} from '@/utils/validators'`
    - Removed unused type imports: `TextMessage`, `ImageMessage`, `MixedMessage`
  - **Explanation**: Moving type guard functions to a centralized validators.ts file improves code organization and makes them reusable across the codebase.
  
## [2026-01-07 18:00] Complete Globalization of System Messages
- **Goal**: Add missing system message translations to all language files
- **Changes**:
  - [MODIFY] `i18n/locales/zh.json`:
    - Added `system` section with:
      - `room_created`: "房间已创建"
      - `member_joined`: "{0} 加入了群聊"
      - `guest_joined`: "{0} 以访客身份加入了群聊"
  - [MODIFY] `i18n/locales/en.json`:
    - Updated `system` section with:
      - `room_created`: "Room created"
      - `member_joined`: "{0} joined the group"
      - `guest_joined`: "{0} joined the group as a guest"
  - [MODIFY] `i18n/locales/ja.json`:
    - Added `system` section with:
      - `room_created`: "ルームが作成されました"
      - `member_joined`: "{0} がグループに参加しました"
      - `guest_joined`: "{0} がゲストとしてグループに参加しました"
  - [MODIFY] `i18n/locales/ko.json`:
    - Added `system` section with:
      - `room_created`: "룸이 생성되었습니다"
      - `member_joined`: "{0} 님이 그룹에 참여했습니다"
      - `guest_joined`: "{0} 님이 게스트로 그룹에 참여했습니다"
  - [MODIFY] `i18n/locales/zh-tw.json`:
    - Added `system` section with:
      - `room_created`: "房間已建立"
      - `member_joined`: "{0} 加入了群聊"
      - `guest_joined`: "{0} 以訪客身份加入了群聊"
  - **Explanation**: System messages (room creation, member join, guest join) are now fully internationalized across all supported languages.
## [2026-01-07 17:49] Fix useChatInput TS Error
- **Goal**: Fix "Argument of type 'Image' is not assignable to parameter of type 'never'" error.
- **Changes**: src/hooks/useChatInput.ts (Adjusted inputContent type definition to allow images array in draft state).
## [2026-01-07 17:51] Fix MessageItem Runtime Crash
- **Goal**: Fix "Cannot read properties of null (reading 'forEach')" error in MessageItem.vue.
- **Changes**: src/views/chat/components/MessageItem.vue (Added strict Array.isArray check for messageImages).
## [2026-01-07 17:57] Fix MyBatis BindingException
- **Goal**: Resolve "Invalid bound statement" for UserMapper methods.
- **Changes**: src/main/resources/hal/th50743/mapper/UserMapper.xml (Added XML mappings for getUserById and getUsernameByUserId).
## [2026-01-07 18:04] Fix WebSocket Parse Error
- **Goal**: Fix "SyntaxError: Unexpected token 'm'" when parsing ACK messages.
- **Changes**: src/WS/useWebsocket.ts (Updated parseData to safely handle non-JSON strings).
## [2026-01-07 18:15] Relax WebSocket Validation
- **Goal**: Fix message loss due to overly strict type guarding in useWebsocket.ts.
- **Changes**: 
  - src/WS/useWebsocket.ts (Allowed loose  payload).
  - src/stores/websocketStore.ts (Accepted  payload and cast to ).
## [2026-01-07 18:21] Implement Runtime Validation
- **Goal**: Move strict message validation from transport layer to business layer.
- **Changes**:
  - src/utils/validators.ts (Added isValidMessage type guard).
  - src/stores/websocketStore.ts (Removed dangerous cast, passing raw data).
  - src/stores/messageStore.ts (Implemented runtime validation using validMessage).
## [2026-01-07 18:32] Fix Room Member Hydration Bug
- **Goal**: Fix insufficient member list loading issue caused by partial hydration.
- **Changes**: src/stores/roomStore.ts (Updated addRoomMember to only append to already populated lists).
## [2026-01-07 18:39] Debug Backend Payload
- **Goal**: Verify if  payload actually contains the  object.
- **Changes**: backend/EZChat-app/src/main/java/hal/th50743/service/impl/ChatServiceImpl.java (Added INFO logs).
## [2026-01-07 18:41] Debug Join Validation
- **Goal**: Fix INVITE_URL_REQUIRED error when joining via password mode.
- **Changes**: frontend/vue-ezchat/src/hooks/chat/join/useJoinInput.ts (Added debug logs).
## [2026-01-07 18:43] Fix Join Validation UX
- **Goal**: Handle raw validation errors gracefully with toast messages instead of UNKNOWN system errors.
- **Changes**: frontend/vue-ezchat/src/hooks/chat/join/useJoinInput.ts.

## [2026-01-07 18:45] Fix TS Error in useJoinInput
- **Goal**: Resolve "Type 'string | undefined' is not assignable" error.
- **Changes**: 
  - `frontend/vue-ezchat/src/hooks/chat/join/useJoinInput.ts` (Refactored error handling in `validateAndGetPayload`)

## [2026-01-07 19:02] Refactor Backend Service Logic
- **Goal**: Move Chat Join business logic from `AuthService` to `ChatService`.
- **Changes**: 
  - `backend/EZChat-app/src/main/java/hal/th50743/service/impl/AuthServiceImpl.java` (Refactored `joinChat` to delegate to `chatService.join`, removed unused mappers)

## [2026-01-07 19:18] Fix Broadcast Logic
- **Goal**: Fix guest join broadcast not delivering.
- **Changes**: 
  - `backend/EZChat-app/src/main/java/hal/th50743/service/impl/ChatServiceImpl.java` (Switched to `getChatMemberListByChatId` to avoid `UserId` filtering issues)

## [2026-01-07 19:24] Fix Guest System Message Logic
- **Goal**: Fix guest join system message not being persisted.
- **Changes**: 
  - `backend/EZChat-app/src/main/java/hal/th50743/service/impl/ChatServiceImpl.java` (Refactored `isGuest` check to be more efficient, handled `assetIds` null safety)

## [2026-01-07 19:29] Sync Member Avatar
- **Goal**: Ensure new chat member avatar is fetched before adding to list.
- **Changes**: 
  - `frontend/vue-ezchat/src/stores/websocketStore.ts` (Modified `onChatMemberAdd` to await `imageStore.ensureThumbBlobUrl`)

## [2026-01-07 19:54] Fix Avatar Pre-fetch Compatibility
- **Goal**: Fix avatar pre-fetch skipping due to legacy field names (`objectName` vs `imageName`).
- **Changes**: 
  - `frontend/vue-ezchat/src/stores/websocketStore.ts` (Added compatibility check for `objectName`/`objectUrl` and normalized them before calling `ensureThumbBlobUrl`)

## [2026-01-07 20:15] 为 WebSocketServer.java 添加详细中文注释
|- **Goal**: 为 WebSocket 服务端点添加全面、详细的中文注释，提高代码可读性和维护性
|- **Changes**:
  - `backend/EZChat-app/src/main/java/hal/th50743/ws/WebSocketServer.java`:
    - 添加了所有导入包的详细注释说明
    - 扩展了类级别的详细功能描述和设计说明
    - 为所有成员变量添加了详细的作用和生命周期说明
    - 为每个方法添加了完整的 Javadoc 注释，包括参数说明、返回值、异常处理
    - 在关键业务逻辑处添加了行内注释，解释复杂逻辑
    - 详细说明了防抖机制、线程安全考虑和性能优化点
    - 添加了异常处理策略的业务逻辑说明
    - 统一了注释格式，符合项目编码规范

## [2026-01-07 20:30] 为 ChatServiceImpl.java 添加详细中文注释
|- **Goal**: 为聊天服务核心实现类添加全面、详细的中文注释，提高代码可读性和维护性
|- **Changes**:
  - `backend/EZChat-app/src/main/java/hal/th50743/service/impl/ChatServiceImpl.java`:
    - 添加了所有导入包的详细注释说明
    - 为所有依赖注入组件添加了详细的作用说明
    - 为缺少注释的方法添加了完整的Javadoc文档
    - 详细说明了事务管理策略和回滚机制
    - 添加了关键业务逻辑的行内注释和解释
    - 完善了异常处理和安全考虑的注释说明
    - 统一了注释格式和深度，符合项目编码规范
## [2026-01-07 21:18] Refactor ChatServiceImpl Decoupling
- **Goal**: Extract ChatMember logic and MinIO dependencies from ChatServiceImpl to new ChatMemberAssembler.
- **Changes**: 
  - Created `backend/EZChat-app/src/main/java/hal/th50743/assembler/ChatMemberAssembler.java`
  - Modified `backend/EZChat-app/src/main/java/hal/th50743/assembler/ChatAssembler.java`
  - Modified `backend/EZChat-app/src/main/java/hal/th50743/service/impl/ChatServiceImpl.java`
## [2026-01-07 21:20] Fix Syntax Error in GuestAside.vue
- **Goal**: Fix missing style end tag
- **Changes**: 
  - GuestAside.vue (Appended </style>)

## [2026-01-07 21:30] Update Documentation
- **Goal**: Synchronize README with recent code changes (WebSocket protocol, I18n).
- **Changes**:
  - [MODIFY] `README.md`: Updated Features, WebSocket Protocol section, added Changelog.

## [2026-01-07 21:30] Update Documentation (Debounce)
- **Goal**: Add 'Presence Debounce' feature to README.
- **Changes**:
  - [MODIFY] `README.md`: Added debounce description in Features and Changelog.

## [2026-01-08 06:15] Refactor UserAssembler
- **Goal**: Reuse ImageUtils logic for image URL generation to ensure consistency and reduce duplication.
- **Changes**:
  - [MODIFY] `backend/EZChat-app/src/main/java/hal/th50743/assembler/UserAssembler.java`: Replaced manual MinioOSSResult handling with `ImageUtils.buildImage`. Cleaned up imports.

## [2026-01-08 06:17] Refactor ChatMemberAssembler
- **Goal**: Consolidate avatar image building logic and reuse `ImageUtils.buildImage`.
- **Changes**:
  - [MODIFY] `backend/EZChat-app/src/main/java/hal/th50743/assembler/ChatMemberAssembler.java`: Extracted `buildAvatar` private method. Refactored `toChatMemberVO` methods to use it.

## [2026-01-08 06:33] Add Logging Configuration
- **Goal**: Configure profile-specific logging for Dev (Console) and Prod (File).
- **Changes**:
  - [NEW] `backend/EZChat-app/src/main/resources/logback-spring.xml`: Configured INFO/ERROR file appenders and color console output.

## [2026-01-08 06:35] Add Usage Audit Infrastructure
- **Goal**: Create infrastructure for recording user operation logs.
- **Changes**:
  - [NEW] `OperationLog.java`: POJO for audit logs.
  - [NEW] `OperationLogMapper.java`: MyBatis mapper interface.
  - [NEW] `OperationLogMapper.xml`: XML mapping for insert operation.

## [2026-01-08 06:40] Implement Audit Log AOP
- **Goal**: Implement Aspect-oriented audit logging with async saving.
- **Changes**:
  - [NEW] `LogAspect.java`: Aspect to intercept methods, parse SpEL, and capture context.
  - [NEW] `AsyncLogService.java`: Async service to insert logs.
  - [NEW] `LogRecord.java`: Annotation definition.
  - [MODIFY] `EzChatAppApplication.java`: Enabled Async support.

## [2026-01-08 06:45] Fix LogAspect Compilation Error
- **Goal**: Fix 'AfterReturning cannot be resolved' error in LogAspect.java
- **Changes**: added spring-boot-starter-aop to backend/EZChat-app/pom.xml
