# Execution Plan: Refactor Backend Join Logic

## Problem Analysis
User report: Responsibility mismatch.
- `AuthServiceImpl` currently handles "Guest Join" but it should only handle validation/login-like actions.
- The actual logic of "checking room availability", "consuming invite code", "adding user to room member list" belongs to `ChatService`.
- `AuthService` should:
    1. Validate Request.
    2. Create Guest User (using `UserService`).
    3. Delegate the "Join Room" logic entirely to `ChatService`.
- `ChatService` should encapsulate all "Join" logic, including:
    - Verifying ChatCode/Password or InviteCode.
    - Handling Invite Code consumption and rules (expiry, max uses).
    - Adding member to DB.
    - Broadcasting system messages.

## Proposed Changes

### 1. `ChatService.java` & `ChatServiceImpl.java`
- **Method**: `join(JoinChatReq joinChatReq)` needs to remain but handle the full logic.
- **Refactoring**: Move the Invite Code logic from `AuthServiceImpl.joinChat` (lines 266-314 of AuthServiceImpl) INTO `ChatServiceImpl`.
- **New Method**: `Chat joinByInviteCode(Integer userId, String inviteCode)` (or integrate into existing `join`).
    - Currently `joinChatReq` has `inviteCode`, so `join` method inside `ChatServiceImpl` likely already has logic (lines 483-485 calls `handleInviteJoin`).
    - **Wait**, `AuthServiceImpl` duplicates logic! It manually checks invite code, consumes it, etc. (lines 270-301 in AuthServiceImpl).
    - **Fix**: `AuthServiceImpl` should just create the user, then call `chatService.join(req)`.

### 2. `AuthServiceImpl.java`
- **Refactor `joinChat(GuestJoinReq req)`**:
    1. Validate input (nickname, avatar).
    2. Validate mutually exclusive modes (Pwd vs Invite).
    3. Create Guest User (`userService.add`).
    4. Construct `JoinChatReq` (DTO).
        - If Pwd Mode: `chatCode`, `password`.
        - If Invite Mode: `inviteCode`.
    5. Call `chatService.join(joinChatReq)`.
    6. Return `LoginVO` (Token).

### 3. Verification of `ChatServiceImpl`
- Check `handleInviteJoin` (private method in `ChatServiceImpl`).
    - Does it handle "Consume"? Yes (lines 773).
    - Does it handle "Delete single-use"? Yes (lines 781).
    - **Conclusion**: `ChatServiceImpl` is already robust. `AuthServiceImpl` was just re-implementing it incorrectly/redundantly.

## Detailed Plan

1.  **Modify `AuthServiceImpl.java`**:
    - Remove all lines (267-304) that manually handle invite codes.
    - Remove `ChatInviteMapper` dependency if no longer needed (it seems only used for that block).
    - Unify the call to `chatService.join(...)` for both modes.

```java
// Simplified Logic in AuthServiceImpl::joinChat
User guestUser = userService.add(userReq);

JoinChatReq joinReq = new JoinChatReq();
joinReq.setUserId(guestUser.getId());
if (isInviteMode) {
    joinReq.setInviteCode(req.getInviteCode());
} else {
    joinReq.setChatCode(req.getChatCode());
    joinReq.setPassword(req.getPassword());
}

// Delegate everything to ChatService
Chat chat = chatService.join(joinReq);
```

2.  **Verify `ChatServiceImpl.java`**:
    - Ensure `join` supports the `JoinChatReq` populated above.
    - `join` calls `handleInviteJoin` if invite code is present.
    - `handleInviteJoin` does all the necessary checks and updates.
    - `join` adds member and broadcasts.

This aligns perfectly with the user's request: "AuthService only validates request -> calls UserService to Register -> calls ChatService to Join".

## Execution Steps
1.  Verify imports in `AuthServiceImpl`.
2.  Rewire `joinChat` in `AuthServiceImpl`.
3.  Remove unused dependencies (`ChatInviteMapper`, `ChatMemberMapper`) from `AuthServiceImpl` if they are no longer used after refactor.

## Waiting for Command
Plan is ready. Waiting for user approval.