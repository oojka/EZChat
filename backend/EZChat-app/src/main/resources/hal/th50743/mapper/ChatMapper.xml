<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="hal.th50743.mapper.ChatMapper">

    <select id="selectChatIdByChatCode" resultType="java.lang.Integer">
        SELECT id FROM chats WHERE chat_code = #{chatCode}
    </select>

    <select id="selectChatVOListByUserId" resultType="hal.th50743.pojo.ChatVO">
        SELECT c.chat_code,
               c.chat_name, c.type,
               u.uid owner_uid,
               c.join_enabled,
               CASE
                   WHEN c.chat_password_hash IS NULL OR c.chat_password_hash = '' THEN 0
                   ELSE 1
               END AS password_enabled,
               c.max_members,
               c.announcement,
               c.create_time,
               c.update_time,
               a.asset_name AS avatarAssetName,
               (SELECT COUNT(*) FROM chat_members cm WHERE cm.chat_id = c.id) member_count
        FROM chats c 
        JOIN users u ON c.owner_id = u.id
        LEFT JOIN assets a ON c.asset_id = a.id
        WHERE EXISTS(
            SELECT * FROM chat_members m
            WHERE c.id = m.chat_id
            AND m.user_id = #{userId} )
        AND c.type = 0
    </select>

    <select id="isValidChatId" resultType="java.lang.Boolean">
        SELECT IF(COUNT(*) > 0, 1, 0)
        FROM chat_members
        WHERE chat_id = #{chatId} AND user_id = #{userId}
    </select>
    <select id="selectChatVOByChatId" resultType="hal.th50743.pojo.ChatVO">
        SELECT c.chat_code,
               c.chat_name, c.type,
               u.uid owner_uid,
               c.join_enabled,
               CASE
                   WHEN c.chat_password_hash IS NULL OR c.chat_password_hash = '' THEN 0
                   ELSE 1
               END AS password_enabled,
               c.max_members,
               c.announcement,
               c.create_time,
               c.update_time,
               a.asset_name AS avatarAssetName,
               (SELECT COUNT(*) FROM chat_members cm WHERE cm.chat_id = c.id) member_count
        FROM chats c 
        JOIN users u ON c.owner_id = u.id
        LEFT JOIN assets a ON c.asset_id = a.id
        WHERE c.id = #{chatId}
    </select>

    <select id="selectAssetIdByChatId" resultType="java.lang.Integer">
        SELECT asset_id FROM chats WHERE id = #{chatId}
    </select>

    <select id="selectJoinInfoByChatId" resultType="hal.th50743.pojo.ChatJoinInfo">
        SELECT id chatId,
               chat_code,
               chat_name,
               join_enabled,
               chat_password_hash,
               max_members
        FROM chats
        WHERE id = #{chatId}
    </select>
    <select id="selectChatIdByInviteCodeHash" resultType="java.lang.Integer">
        SELECT i.chat_id
        FROM chat_invites i
         JOIN chats c ON i.chat_id = c.id
        WHERE i.code_hash = #{codeHash}
    </select>

    <insert id="insertChat" parameterType="hal.th50743.pojo.ChatCreate" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO chats
        (chat_code, chat_name, owner_id, chat_password_hash, join_enabled, max_members, type, announcement, asset_id, create_time, update_time)
        VALUES
        (#{chatCode}, #{chatName}, #{ownerId}, #{chatPasswordHash}, #{joinEnabled}, #{maxMembers}, #{type}, #{announcement}, #{objectId}, NOW(), NOW())
    </insert>

    <select id="selectOwnerIdByChatId" resultType="java.lang.Integer">
        SELECT owner_id FROM chats WHERE id = #{chatId}
    </select>

    <update id="updateChatOwner">
        UPDATE chats
        SET owner_id = #{ownerId},
            update_time = NOW()
        WHERE id = #{chatId}
    </update>

    <update id="updateChatPassword">
        UPDATE chats
        SET chat_password_hash = #{passwordHash},
            update_time = NOW()
        WHERE id = #{chatId}
    </update>

    <update id="updateChatBasicInfo">
        UPDATE chats
        SET chat_name = #{chatName},
            max_members = #{maxMembers},
            announcement = #{announcement},
            asset_id = #{assetId},
            update_time = NOW()
        WHERE id = #{chatId}
    </update>

    <delete id="deleteChatById">
        DELETE FROM chats
        WHERE id = #{chatId}
    </delete>

    <select id="selectPrivateChatCodeBetweenUsers" resultType="java.lang.String">
        SELECT c.chat_code
        FROM chats c
        JOIN chat_members cm1 ON c.id = cm1.chat_id
        JOIN chat_members cm2 ON c.id = cm2.chat_id
        WHERE c.type = 1
          AND cm1.user_id = #{u1}
          AND cm2.user_id = #{u2}
        LIMIT 1
    </select>
</mapper>
