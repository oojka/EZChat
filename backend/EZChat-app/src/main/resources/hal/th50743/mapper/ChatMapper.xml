<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="hal.th50743.mapper.ChatMapper">

    <!-- 根据 chatCode 查询聊天室 ID（使用 chat_code 唯一索引） -->
    <select id="selectChatIdByChatCode" resultType="java.lang.Integer">
        SELECT id FROM chats WHERE chat_code = #{chatCode}
    </select>

    <!-- 
      查询用户的聊天室列表（仅群聊）
      
      业务说明：
      - 只返回 type=0 的群聊，私聊通过好友系统入口展示
      - 使用 EXISTS 子查询验证成员关系
      - 包含成员数量统计（子查询 COUNT）
      
      索引依赖：
      - chat_members(user_id, chat_id)
      - chats(type)
    -->
    <select id="selectChatVOListByUserId" resultType="hal.th50743.pojo.ChatVO">
        SELECT c.chat_code,
               c.chat_name, c.type,
               u.uid owner_uid,
               c.join_enabled,
               CASE
                   WHEN c.chat_password_hash IS NULL OR c.chat_password_hash = '' THEN 0
                   ELSE 1
               END AS password_enabled,
               c.max_members,
               c.announcement,
               c.create_time,
               c.update_time,
               a.asset_name AS avatarAssetName,
               (SELECT COUNT(*) FROM chat_members cm WHERE cm.chat_id = c.id) member_count
        FROM chats c 
        JOIN users u ON c.owner_id = u.id
        LEFT JOIN assets a ON c.asset_id = a.id
        WHERE EXISTS(
            SELECT * FROM chat_members m
            WHERE c.id = m.chat_id
            AND m.user_id = #{userId} )
        AND c.type = 0
    </select>

    <!-- 验证用户是否是聊天室成员（使用 chat_members 联合主键） -->
    <select id="isValidChatId" resultType="java.lang.Boolean">
        SELECT IF(COUNT(*) > 0, 1, 0)
        FROM chat_members
        WHERE chat_id = #{chatId} AND user_id = #{userId}
    </select>

    <!-- 
      根据 chatId 查询聊天室详情
      
      业务说明：
      - 返回完整聊天室信息，包含群主、头像、成员数
      - password_enabled 通过 CASE 判断是否设置密码
      
      索引依赖：
      - chats(id) 主键
    -->
    <select id="selectChatVOByChatId" resultType="hal.th50743.pojo.ChatVO">
        SELECT c.chat_code,
               c.chat_name, c.type,
               u.uid owner_uid,
               c.join_enabled,
               CASE
                   WHEN c.chat_password_hash IS NULL OR c.chat_password_hash = '' THEN 0
                   ELSE 1
               END AS password_enabled,
               c.max_members,
               c.announcement,
               c.create_time,
               c.update_time,
               a.asset_name AS avatarAssetName,
               (SELECT COUNT(*) FROM chat_members cm WHERE cm.chat_id = c.id) member_count
        FROM chats c 
        JOIN users u ON c.owner_id = u.id
        LEFT JOIN assets a ON c.asset_id = a.id
        WHERE c.id = #{chatId}
    </select>

    <!-- 获取聊天室头像资源 ID（用于更新头像时判断是否需要删除旧头像） -->
    <select id="selectAssetIdByChatId" resultType="java.lang.Integer">
        SELECT asset_id FROM chats WHERE id = #{chatId}
    </select>

    <!-- 
      获取加入校验所需的最小信息
      
      业务说明：
      - 轻量查询，仅返回加入校验必需字段
      - 避免查询完整聊天室信息
    -->
    <select id="selectJoinInfoByChatId" resultType="hal.th50743.pojo.ChatJoinInfo">
        SELECT id chatId,
               chat_code,
               chat_name,
               join_enabled,
               chat_password_hash,
               max_members
        FROM chats
        WHERE id = #{chatId}
    </select>

    <!-- 根据邀请码哈希查询聊天室 ID（JOIN 验证聊天室存在性） -->
    <select id="selectChatIdByInviteCodeHash" resultType="java.lang.Integer">
        SELECT i.chat_id
        FROM chat_invites i
         JOIN chats c ON i.chat_id = c.id
        WHERE i.code_hash = #{codeHash}
    </select>

    <!-- 
      插入聊天室记录
      
      业务说明：
      - 使用 useGeneratedKeys 回填自增 ID
      - 注意 objectId 映射到 asset_id 字段
    -->
    <insert id="insertChat" parameterType="hal.th50743.pojo.ChatCreate" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO chats
        (chat_code, chat_name, owner_id, chat_password_hash, join_enabled, max_members, type, announcement, asset_id, create_time, update_time)
        VALUES
        (#{chatCode}, #{chatName}, #{ownerId}, #{chatPasswordHash}, #{joinEnabled}, #{maxMembers}, #{type}, #{announcement}, #{objectId}, NOW(), NOW())
    </insert>

    <!-- 获取聊天室群主 ID（用于群主权限校验） -->
    <select id="selectOwnerIdByChatId" resultType="java.lang.Integer">
        SELECT owner_id FROM chats WHERE id = #{chatId}
    </select>

    <!-- 更新聊天室群主（用于群主转让） -->
    <update id="updateChatOwner">
        UPDATE chats
        SET owner_id = #{ownerId},
            update_time = NOW()
        WHERE id = #{chatId}
    </update>

    <!-- 更新聊天室密码（null 表示关闭密码保护） -->
    <update id="updateChatPassword">
        UPDATE chats
        SET chat_password_hash = #{passwordHash},
            update_time = NOW()
        WHERE id = #{chatId}
    </update>

    <!-- 批量更新聊天室基础信息（一次 SQL 完成多字段更新） -->
    <update id="updateChatBasicInfo">
        UPDATE chats
        SET chat_name = #{chatName},
            max_members = #{maxMembers},
            announcement = #{announcement},
            asset_id = #{assetId},
            update_time = NOW()
        WHERE id = #{chatId}
    </update>

    <!-- 物理删除聊天室记录（需先删除关联的成员、消息、邀请码） -->
    <delete id="deleteChatById">
        DELETE FROM chats
        WHERE id = #{chatId}
    </delete>

    <!-- 
      查询两用户间的私聊房间代码
      
      业务说明：
      - 查询 type=1（私聊）的聊天室
      - 要求双方都是成员（双 JOIN chat_members）
      - LIMIT 1 优化性能
      
      索引依赖：
      - chats(type)
      - chat_members(chat_id, user_id)
    -->
    <select id="selectPrivateChatCodeBetweenUsers" resultType="java.lang.String">
        SELECT c.chat_code
        FROM chats c
        JOIN chat_members cm1 ON c.id = cm1.chat_id
        JOIN chat_members cm2 ON c.id = cm2.chat_id
        WHERE c.type = 1
          AND cm1.user_id = #{u1}
          AND cm2.user_id = #{u2}
        LIMIT 1
    </select>
</mapper>
