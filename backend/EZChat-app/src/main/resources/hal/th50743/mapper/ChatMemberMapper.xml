<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="hal.th50743.mapper.ChatMemberMapper">

    <!-- 插入聊天室成员关系 -->
    <insert id="insertChatMember">
        INSERT INTO chat_members
        (chat_id, user_id, last_seen_at, create_time, update_time)
        VALUES (#{chatId}, #{userId}, #{now}, #{now}, #{now})
    </insert>

    <!-- 更新成员在聊天室中的最后活跃时间（用于未读消息计算） -->
    <update id="updateLastSeenAt">
        UPDATE chat_members
        SET last_seen_at = #{now}
        WHERE user_id = #{userId}
        AND chat_id = #{chatId}
    </update>

    <!-- 
      获取用户关联的所有成员 ID 列表
      
      业务说明：
      - 查询当前用户所在的所有聊天室中的所有成员 ID（去重）
      - 排除已删除用户（is_deleted = 0）
      
      索引依赖：
      - chat_members(user_id)
    -->
    <select id="selectChatMembersById" resultType="java.lang.Integer">
        SELECT DISTINCT u.id
        FROM users u
        JOIN chat_members m ON u.id = m.user_id
        WHERE m.chat_id IN (
        SELECT chat_id
        FROM chat_members
        WHERE user_id = #{Id} )
          AND u.is_deleted = 0
    </select>

    <!-- 
      获取指定聊天室的所有成员 ID 列表
      
      业务说明：
      - 包含权限校验（EXISTS 子查询验证请求者是成员）
      - 仅当 userId 是该聊天室成员时才返回结果
    -->
    <select id="selectChatMembersByUserIdAndChatId" resultType="java.lang.Integer">
        SELECT user_id
        FROM chat_members
        WHERE chat_id = #{chatId}
          AND EXISTS (
            SELECT *
            FROM chat_members
            WHERE user_id = #{userId}
              AND chat_id = #{chatId}
        );
    </select>

    <!-- 
      获取用户所在所有聊天室的成员详情列表
      
      业务说明：
      - 返回完整成员信息（nickname、avatar 等）
      - 用于初始化时一次性获取所有成员数据
      - JOIN users 和 assets 表
      
      索引依赖：
      - chat_members(user_id)
      - users(id) 主键
    -->
    <select id="selectChatMemberListByUserId" resultType="hal.th50743.pojo.ChatMember">
        SELECT m.chat_id,
               c.chat_code,
               m.user_id,
               u.uid,
               u.nickname,
               u.asset_id,
               a.asset_name as avatarAssetName,
               m.last_seen_at,
               m.create_time,
               m.update_time FROM chats c
            JOIN ( chat_members m JOIN users u ON m.user_id = u.id AND u.is_deleted = 0 LEFT JOIN assets a ON u.asset_id = a.id )
            ON c.id = m.chat_id
        WHERE m.chat_id IN (SELECT chat_id
        FROM chat_members cm WHERE cm.user_id = #{userId})
    </select>

    <!-- 
      获取用户所在所有聊天室的轻量成员列表
      
      业务说明：
      - 仅返回 userId、uid、lastSeenAt、chatCode
      - 用于初始化阶段聚合在线状态/计算在线人数
      - 避免携带 nickname/avatar 导致数据量过大
    -->
    <select id="selectChatMemberLiteListByUserId" resultType="hal.th50743.pojo.ChatMemberLite">
        SELECT c.chat_code  AS chatCode,
               m.user_id    AS userId,
               u.uid        AS uid,
               m.last_seen_at AS lastSeenAt
        FROM chats c
                 JOIN chat_members m ON c.id = m.chat_id
                 JOIN users u ON m.user_id = u.id AND u.is_deleted = 0
        WHERE m.chat_id IN (
            SELECT chat_id
            FROM chat_members cm
            WHERE cm.user_id = #{userId}
        )
    </select>

    <!-- 获取指定聊天室的所有成员详情列表 -->
    <select id="selectChatMemberListByChatId" resultType="hal.th50743.pojo.ChatMember">
        SELECT m.chat_id,
               c.chat_code,
               m.user_id,
               u.uid,
               u.nickname,
               u.asset_id as assetId,
               a.asset_name as avatarAssetName,
               m.last_seen_at,
               m.create_time,
               m.update_time
        FROM chats c
                 JOIN chat_members m ON c.id = m.chat_id
                 JOIN users u ON m.user_id = u.id AND u.is_deleted = 0
                 LEFT JOIN assets a ON u.asset_id = a.id
        WHERE c.id = #{chatId}
    </select>

    <!-- 
      验证用户是否有权获取目标用户的信息
      
      业务说明：
      - 校验请求者和目标用户是否在同一个聊天室中
      - 用于用户信息接口的权限控制
    -->
    <select id="isValidGetInfoReq" resultType="java.lang.Boolean">
        SELECT IF(COUNT(*) > 0, 1, 0)
        FROM chat_members
        WHERE user_id = #{reqId}
          AND chat_id IN (
              SELECT chat_id
              FROM chat_members
              WHERE user_id = #{id}
            )
    </select>

    <!-- 删除单个成员关系（用户退出或被踢出） -->
    <delete id="deleteChatMember">
        DELETE FROM chat_members
        WHERE chat_id = #{chatId}
          AND user_id = #{userId}
    </delete>

    <!-- 删除聊天室全部成员（解散聊天室时调用） -->
    <delete id="deleteChatMembersByChatId">
        DELETE FROM chat_members
        WHERE chat_id = #{chatId}
    </delete>

    <!-- 批量删除聊天室成员（群主批量踢人） -->
    <delete id="deleteChatMembersByChatIdAndUserIds">
        DELETE FROM chat_members
        WHERE chat_id = #{chatId}
          AND user_id IN
        <foreach collection="userIds" item="userId" open="(" close=")" separator=",">
            #{userId}
        </foreach>
    </delete>

    <!-- 按用户删除其所有成员关系（访客清理使用） -->
    <delete id="deleteChatMembersByUserId">
        DELETE FROM chat_members
        WHERE user_id = #{userId}
    </delete>

    <!-- 统计聊天室成员数（用于加入校验） -->
    <select id="countMembersByChatId" resultType="int">
        SELECT COUNT(*)
        FROM chat_members cm
        JOIN users u ON cm.user_id = u.id
        WHERE cm.chat_id = #{chatId}
          AND u.is_deleted = 0
    </select>

</mapper>
