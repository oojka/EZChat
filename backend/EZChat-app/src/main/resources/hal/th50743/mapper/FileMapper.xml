<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="hal.th50743.mapper.FileMapper">

    <!-- 插入文件记录 -->
    <insert id="insert" parameterType="hal.th50743.pojo.FileEntity" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO objects (object_name, original_name, content_type, file_size, category, message_id, status, raw_object_hash, normalized_object_hash, create_time, update_time)
        VALUES (#{objectName}, #{originalName}, #{contentType}, #{fileSize}, #{category}, #{messageId}, #{status}, #{rawObjectHash}, #{normalizedObjectHash}, NOW(), NOW())
    </insert>

    <!-- 根据 ID 查询文件记录（使用主键索引） -->
    <select id="findById" resultType="hal.th50743.pojo.FileEntity">
        SELECT id, object_name, original_name, content_type, file_size, category, message_id, status, raw_object_hash, normalized_object_hash, create_time, update_time
        FROM objects
        WHERE id = #{id}
        LIMIT 1
    </select>

    <!-- 根据 objectName 查询文件记录（使用 idx_object_name 索引） -->
    <select id="findByObjectName" resultType="hal.th50743.pojo.FileEntity">
        SELECT id, object_name, original_name, content_type, file_size, category, message_id, status, raw_object_hash, normalized_object_hash, create_time, update_time
        FROM objects
        WHERE object_name = #{objectName}
        LIMIT 1
    </select>

    <!-- 根据 messageId 查询关联的文件列表（使用 idx_message_id 索引） -->
    <select id="findByMessageId" resultType="hal.th50743.pojo.FileEntity">
        SELECT id, object_name, original_name, content_type, file_size, category, message_id, status, raw_object_hash, normalized_object_hash, create_time, update_time
        FROM objects
        WHERE message_id = #{messageId}
    </select>

    <!-- 批量更新文件状态（用于消息图片激活，一次 SQL 完成所有图片的状态更新） -->
    <update id="updateStatusBatch">
        UPDATE objects
        SET status = #{status},
            category = #{category},
            message_id = #{messageId},
            update_time = NOW()
        WHERE object_name IN
        <foreach collection="objectNames" item="name" open="(" separator="," close=")">
            #{name}
        </foreach>
    </update>

    <!-- 更新单个文件的状态和分类 -->
    <update id="updateStatusAndCategory">
        UPDATE objects
        SET status = #{status},
            <if test="category != null">
            category = #{category},
            </if>
            update_time = NOW()
        WHERE object_name = #{objectName}
    </update>

    <!-- 更新单个文件的状态 -->
    <update id="updateStatus">
        UPDATE objects
        SET status = #{status},
            update_time = NOW()
        WHERE object_name = #{objectName}
    </update>

    <!-- 分页查询待清理的 PENDING 文件（用于 GC，使用 idx_gc_cleanup 索引） -->
    <select id="findPendingFilesBefore" resultType="hal.th50743.pojo.FileEntity">
        SELECT id, object_name, original_name, content_type, file_size, category, message_id, status, raw_object_hash, normalized_object_hash, create_time, update_time
        FROM objects
        WHERE status = 0 AND create_time &lt; #{beforeTime}
        ORDER BY create_time ASC
        LIMIT #{limit} OFFSET #{offset}
    </select>

    <!-- 根据 ID 删除文件记录 -->
    <delete id="deleteById">
        DELETE FROM objects WHERE id = #{id}
    </delete>

    <!-- 批量删除文件记录（可选，用于提升 GC 性能） -->
    <delete id="deleteByIds">
        DELETE FROM objects WHERE id IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </delete>

    <!-- 根据原始对象哈希查询已激活的对象（用于前端轻量级比对，使用 idx_raw_object_hash 索引） -->
    <select id="findByRawHashAndActive" resultType="hal.th50743.pojo.FileEntity">
        SELECT id, object_name, original_name, content_type, file_size, category, message_id, status, raw_object_hash, normalized_object_hash, create_time, update_time
        FROM objects
        WHERE raw_object_hash = #{rawHash} AND status = 1
        LIMIT 1
    </select>

    <!-- 根据规范化对象哈希查询已激活的对象（用于后端最终去重，使用 idx_normalized_object_hash 索引） -->
    <select id="findByNormalizedHashAndActive" resultType="hal.th50743.pojo.FileEntity">
        SELECT id, object_name, original_name, content_type, file_size, category, message_id, status, raw_object_hash, normalized_object_hash, create_time, update_time
        FROM objects
        WHERE normalized_object_hash = #{normalizedHash} AND status = 1
        LIMIT 1
    </select>

</mapper>

