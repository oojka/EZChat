<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="hal.th50743.mapper.UserMapper">
    <insert id="insertUser"
            parameterType="hal.th50743.pojo.User"
            useGeneratedKeys="true"
            keyProperty="id"
            keyColumn="id">
        INSERT INTO users (uid, nickname, asset_id, bio, last_seen_at, create_time, update_time)
        VALUES (#{uid}, #{nickname}, #{assetId}, #{bio}, #{lastSeenAt}, #{createTime}, #{updateTime})
    </insert>

    <insert id="insertFormalUser">
        INSERT INTO formal_users (user_id, username, password_hash, create_time, update_time, last_login_time)
        VALUES (#{userId}, #{username}, #{passwordHash}, #{createTime}, #{updateTime}, #{lastLoginTime})
    </insert>

    <update id="update">
        UPDATE users
        <set>
            <if test="nickname != null and nickname != ''">nickname = #{nickname},</if>
            <if test="assetId != null">asset_id = #{assetId},</if>
            <if test="bio != null and bio != ''">bio = #{bio},</if>
            <if test="updateTime != null">update_time = #{updateTime},</if>
        </set>
        WHERE id = #{id}
    </update>
    <update id="updateLastSeenAt">
        UPDATE users
        SET last_seen_at = #{now}
        WHERE id = #{userId}
    </update>

    <select id="selectFormalUserByUsername" resultType="hal.th50743.pojo.FormalUser">
        SELECT user_id as userId,
               username,
               password_hash as passwordHash,
               create_time as createTime,
               update_time as updateTime,
               last_login_time as lastLoginTime
        FROM formal_users
        WHERE username = #{username}
    </select>

    <select id="selectUserByUsername" resultType="hal.th50743.pojo.User">
        SELECT u.id,
               u.uid,
               u.nickname,
               u.asset_id,
               u.bio,
               u.last_seen_at,
               u.create_time,
               u.update_time,
               f.username
        FROM formal_users f JOIN users u ON f.user_id = u.id
        WHERE f.username = #{username}
    </select>

    <select id="selectByUid" resultType="hal.th50743.pojo.User">
        SELECT u.id,
               u.uid,
               u.nickname,
               u.asset_id,
               u.bio,
               u.last_seen_at,
               u.create_time,
               u.update_time,
               f.username
        FROM users u LEFT JOIN formal_users f ON u.id = f.user_id
        WHERE uid = #{userUid}
    </select>

    <select id="selectIdByUid" resultType="java.lang.Integer">
        SELECT id FROM users WHERE uid = #{uid}
    </select>

    <select id="selectUserVOById" resultType="hal.th50743.pojo.User">
        SELECT u.id,
               u.uid,
               u.nickname,
               u.asset_id,
               u.bio,
               u.last_seen_at,
               u.create_time,
               u.update_time,
               f.username
        FROM users u LEFT JOIN formal_users f ON u.id = f.user_id
        WHERE u.id = #{id}

    </select>

    <select id="selectUserByUid" resultType="hal.th50743.pojo.User">
        SELECT u.id,
               u.uid,
               u.nickname,
               u.asset_id,
               u.bio,
               u.last_seen_at,
               u.create_time,
               u.update_time,
               f.username
        FROM users u
                 LEFT JOIN formal_users f ON u.id = f.user_id
        WHERE u.uid = #{uid}
    </select>

    <!-- 根据 UID 查询用户信息（JOIN assets 表获取头像 asset_name） -->
    <select id="selectByUidWithAvatar" resultType="hal.th50743.pojo.User">
        SELECT 
            u.id, u.uid, u.nickname, u.asset_id, u.bio, u.last_seen_at, u.create_time, u.update_time,
            a.asset_name as avatarObjectName
        FROM users u
        LEFT JOIN assets a ON u.asset_id = a.id
        WHERE u.uid = #{uid}
        LIMIT 1
    </select>

    <!-- 根据 ID 查询用户信息（JOIN assets 表） -->
    <select id="selectByIdWithAvatar" resultType="hal.th50743.pojo.User">
        SELECT 
            u.id, u.uid, u.nickname, u.asset_id, u.bio, u.last_seen_at, u.create_time, u.update_time,
            a.asset_name as avatarObjectName
        FROM users u
        LEFT JOIN assets a ON u.asset_id = a.id
        WHERE u.id = #{id}
        LIMIT 1
    </select>

    <select id="selectUsernameByUserId" resultType="java.lang.String">
        SELECT username
        FROM formal_users
        WHERE user_id = #{userId}
    </select>

    <select id="selectUserById" resultType="hal.th50743.pojo.User">
        SELECT u.id,
               u.uid,
               u.nickname,
               u.asset_id,
               u.bio,
               u.last_seen_at,
               u.create_time,
               u.update_time,
               f.username
        FROM users u
                 LEFT JOIN formal_users f ON u.id = f.user_id
        WHERE u.id = #{userId}
    </select>

</mapper>